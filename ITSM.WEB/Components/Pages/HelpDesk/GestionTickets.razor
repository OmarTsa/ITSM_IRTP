@page "/helpdesk/gestion"
@using ITSM.Entidades
@using ITSM.Negocio
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject TicketNegocio TicketNegocio
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-4" Color="Color.Primary"><b>Bandeja de Gestión - OTIC</b></MudText>

    <MudTable Items="@tickets" Hover="true" Elevation="4">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Solicitante</MudTh>
            <MudTh>Título</MudTh>
            <MudTh>Prioridad</MudTh>
            <MudTh>Estado</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">TKT-@context.IdTicket</MudTd>
            <MudTd DataLabel="Solicitante">@context.Solicitante?.Nombres @context.Solicitante?.Apellidos</MudTd>
            <MudTd DataLabel="Título">@context.Titulo</MudTd>
            <MudTd DataLabel="Prioridad">
                <MudChip T="string" Color="@(context.IdPrioridad == 1 ? Color.Error : Color.Default)" Size="Size.Small">
                    @(context.Prioridad?.Nombre ?? "Normal")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Estado">@context.Estado?.Nombre</MudTd>
            <MudTd>
                <MudTooltip Text="Gestionar Ticket">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo($"/helpdesk/detalle/{context.IdTicket}"))" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private List<Ticket> tickets = new();
    protected override async Task OnInitializedAsync()
    {
        try
        {
            tickets = await TicketNegocio.ListarTodosLosTicketsAsync();
        }
        catch
        {
            // Manejo de errores de carga
        }
    }
}