@page "/activos/inventario"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using MudBlazor
@inject InventarioServicio _inventarioServicio
@inject NavigationManager Navigation

@rendermode InteractiveServer

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h5"><b>Inventario de Activos TI</b></MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
               OnClick="@(() => Navigation.NavigateTo("/activos/nuevo"))">
        Nuevo Activo
    </MudButton>
</MudStack>

@if (listaActivos == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
}
else
{
    <MudTable Items="@listaActivos" Hover="true" Bordered="true" Striped="true" Elevation="3"
              Filter="new Func<Activo, bool>(FiltrarBusqueda)">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Equipos Registrados</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="busqueda" Placeholder="Buscar por código, serie o marca..." Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Tipo</MudTh>
            <MudTh>Código Patrimonial</MudTh>
            <MudTh>Marca / Modelo</MudTh>
            <MudTh>Serie</MudTh>
            <MudTh>Usuario Asignado</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Tipo">@context.Tipo?.Nombre</MudTd>
            <MudTd DataLabel="Código">
                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">
                    @context.CodigoPatrimonial
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Marca">@($"{context.Marca} / {context.Modelo}")</MudTd>
            <MudTd DataLabel="Serie">@context.Serie</MudTd>
            <MudTd DataLabel="Usuario">@(context.UsuarioAsignado?.NombreCompleto ?? "Sin asignar")</MudTd>
            <MudTd DataLabel="Acciones">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning"
                               OnClick="@(() => Navigation.NavigateTo($"/activos/editar/{context.IdActivo}"))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@code {
    private List<Activo>? listaActivos;
    private string busqueda = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaActivos = await _inventarioServicio.ListarActivos();
        }
        catch
        {
            listaActivos = new List<Activo>();
        }
    }

    private bool FiltrarBusqueda(Activo a)
    {
        if (string.IsNullOrWhiteSpace(busqueda)) return true;

        if (a.CodigoPatrimonial?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) return true;
        if (a.Serie?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) return true;
        if (a.Marca?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) return true;
        if (a.Modelo?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) return true;

        return false;
    }
}