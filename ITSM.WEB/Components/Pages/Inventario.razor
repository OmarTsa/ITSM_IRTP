@page "/activos/inventario"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using MudBlazor
@inject InventarioServicio _inventarioServicio
@inject NavigationManager Navigation

@* Forzamos InteractiveServer para que el enrutador del servidor tome el control *@
@rendermode InteractiveServer

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h5"><b>Inventario de Activos TI</b></MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
               OnClick="@(() => Navigation.NavigateTo("/activos/nuevo"))">
        Nuevo Activo
    </MudButton>
</MudStack>

@if (listaActivos == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
}
else
{
    <MudTable Items="@listaActivos" Hover="true" Bordered="true" Striped="true" Elevation="3" Filter="new Func<Activo, bool>(Filtrar)">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Equipos Registrados</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="busqueda" Placeholder="Buscar..." Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Tipo</MudTh>
            <MudTh>Código</MudTh>
            <MudTh>Marca / Modelo</MudTh>
            <MudTh>Usuario Asignado</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Tipo">@context.Tipo?.Nombre</MudTd>
            <MudTd DataLabel="Código">
                <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined">
                    @context.CodInventario
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Marca">@context.Nombre</MudTd>
            <MudTd DataLabel="Usuario">@(context.UsuarioAsignado?.NombreCompleto ?? "Sin asignar")</MudTd>
            <MudTd DataLabel="Acciones">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning"
                               OnClick="@(() => Navigation.NavigateTo($"/activos/editar/{context.IdActivo}"))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@code {
    private List<Activo>? listaActivos;
    private string busqueda = "";

    protected override async Task OnInitializedAsync()
    {
        // El servicio ahora funcionará porque registramos HttpClient en Program.cs
        listaActivos = await _inventarioServicio.ListarActivos();
    }

    private bool Filtrar(Activo a)
    {
        if (string.IsNullOrWhiteSpace(busqueda)) return true;
        if (a.CodInventario?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) return true;
        if (a.Nombre?.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ?? false) return true;
        return false;
    }
}