@page "/activos/inventario"
@using ITSM.Entidades
@using ITSM.Negocio
@rendermode InteractiveServer
@inject TicketNegocio Negocio
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <MudText Typo="Typo.h4" Class="mb-4">Inventario de Activos Tecnológicos - IRTP</MudText>

    <MudTable Items="@activos" Hover="true" Elevation="3" Filter="new Func<Activo, bool>(FilterFunc1)" Dense="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Equipos Registrados</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString" Placeholder="Buscar por serie o modelo..." Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Cód. Patrimonial</MudTh>
            <MudTh>Nombre / Modelo</MudTh>
            <MudTh>Serie</MudTh>
            <MudTh>Usuario Asignado</MudTh>
            <MudTh>Estado</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.CodPatrimonial</MudTd>
            <MudTd>@context.Nombre</MudTd>
            <MudTd>@context.Serie</MudTd>
            <MudTd>
                <MudText Typo="Typo.body2">@(context.UsuarioAsignado?.NombreCompleto ?? "DISPONIBLE")</MudText>
            </MudTd>
            <MudTd>
                <MudChip T="string" Color="@(context.ActivoSN == 1 ? Color.Success : Color.Error)" Size="Size.Small">
                    @(context.ActivoSN == 1 ? "Operativo" : "No Operativo")
                </MudChip>
            </MudTd>
            <MudTd>
                <MudTooltip Text="Asignar Usuario">
                    <MudIconButton Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" Size="Size.Small"
                                   OnClick="@(() => AbrirAsignacion(context))" />
                </MudTooltip>
                <MudTooltip Text="Editar">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private List<Activo> activos = new();
    private string searchString = "";

    protected override async Task OnInitializedAsync() => await CargarDatos();

    private async Task CargarDatos()
    {
        activos = await Negocio.ListarActivosAsync();
    }

    private async Task AbrirAsignacion(Activo activo)
    {
        var parameters = new DialogParameters {
            { "ActivoNombre", activo.Nombre },
            { "IdUsuarioActual", activo.IdUsuarioAsignado }
        };

        var dialog = await DialogService.ShowAsync<AsignarActivoDialog>("Gestión de Asignación", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            var nuevoIdUsuario = (int?)result.Data;
            var exito = await Negocio.AsignarActivoAUsuarioAsync(activo.IdActivo, nuevoIdUsuario);
            if (exito)
            {
                Snackbar.Add("Asignación actualizada correctamente", Severity.Success);
                await CargarDatos();
            }
        }
    }

    private bool FilterFunc1(Activo element) => string.IsNullOrWhiteSpace(searchString) ||
        element.Nombre.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
        element.Serie?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true;
}