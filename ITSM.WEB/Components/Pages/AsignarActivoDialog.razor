@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using MudBlazor
@using ITSM.WEB.Helpers
@inject InventarioServicio _inventarioServicio
@inject UsuarioServicio _usuarioServicio
@inject ISnackbar Snackbar
@inject ILogger<Microsoft.AspNetCore.Components.ComponentBase> Logger

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.AssignmentInd" Class="mr-3 mb-n1" />
            Asignar Activo a Usuario
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.body2" Class="mb-4">
                    Seleccione el usuario responsable del equipo:
                    <b>@Activo.Marca @Activo.Modelo</b> (S/N: @Activo.Serie)
                </MudText>
            </MudItem>
            <MudItem xs="12">
                <MudSelect T="int?" Label="Usuario Responsable" Variant="Variant.Outlined"
                           @bind-Value="Activo.IdUsuarioAsignado" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="int?" Value="@((int?)null)">Sin asignar</MudSelectItem>
                    @if (listaUsuarios != null)
                    {
                        @foreach (var user in listaUsuarios)
                        {
                            <MudSelectItem T="int?" Value="@((int?)user.IdUsuario)">@user.NombreCompleto</MudSelectItem>
                        }
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="Activo.UbicacionFisica" Label="Ubicación Física Actual"
                              Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancelar">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="GuardarAsignacion">Confirmar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    // Use object to avoid compile-time dependency on MudBlazor dialog instance type
    [CascadingParameter]
    public object? MudDialogInstance { get; set; }

    [Parameter]
    public Activo Activo { get; set; } = new();

    private List<Usuario>? listaUsuarios;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaUsuarios = await _usuarioServicio.ListarUsuarios();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar usuarios: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Error cargando lista de usuarios");
        }
    }

    private void Cancelar()
    {
        if (!DialogInvoker.SafeCancel(MudDialogInstance, Logger))
        {
            Snackbar.Add("No se pudo cancelar el diálogo", Severity.Warning);
        }
    }

    private async Task GuardarAsignacion()
    {
        try
        {
            await _inventarioServicio.GuardarActivo(Activo);
            Snackbar.Add("Activo asignado correctamente", Severity.Success);

            var closed = DialogInvoker.SafeClose(MudDialogInstance, true, Logger);
            if (!closed)
            {
                Snackbar.Add("No se pudo cerrar el diálogo automáticamente", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar asignación: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Error guardando asignación de activo");
        }
    }
}