@page "/helpdesk/mistickets"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using System.Security.Claims
@inject ITicketServicio _ticketServicio
@inject NavigationManager _nav
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthProvider
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <MudText Typo="Typo.h5">Mis Tickets</MudText>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Href="/helpdesk/nuevo">
            NUEVO TICKET
        </MudButton>
    </div>

    @if (listaTickets == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (!listaTickets.Any())
    {
        <MudAlert Severity="Severity.Info">
            Aún no tienes tickets registrados.
        </MudAlert>
    }
    else
    {
        <MudTable Items="@listaTickets" Hover="true">
            <HeaderContent>
                <MudTh>Código</MudTh>
                <MudTh>Título</MudTh>
                <MudTh>Estado</MudTh>
                <MudTh>Prioridad</MudTh>
                <MudTh>Fecha Creación</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Código">
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                        <b>@(context.CodigoTicket ?? $"#{context.IdTicket}")</b>
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Título">@context.Titulo</MudTd>
                <MudTd DataLabel="Estado">
                    <MudChip T="string" Size="Size.Small" Color="@ObtenerColorEstado(context.IdEstado)">
                        @context.Estado?.Nombre
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Prioridad">
                    <MudChip T="string"
                             Size="Size.Small"
                             Variant="Variant.Text"
                             Style="@($"color:{context.Prioridad?.Color ?? "#000"}; border: 1px solid {context.Prioridad?.Color ?? "#ccc"};")">
                        @context.Prioridad?.Nombre
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Fecha">
                    @context.FechaCreacion.ToString("dd/MM/yyyy HH:mm")
                </MudTd>
                <MudTd DataLabel="Acciones">
                    <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               OnClick="@(() => VerDetalle(context.IdTicket))">
                        Ver
                    </MudButton>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

@code {
    private List<Ticket>? listaTickets;
    private int idUsuarioActual;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Tomamos el id desde el claim estándar NameIdentifier (nameid en el JWT)
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);

            if (idClaim == null || !int.TryParse(idClaim.Value, out idUsuarioActual))
            {
                Snackbar.Add("No se pudo obtener el usuario actual", Severity.Error);
                listaTickets = new List<Ticket>();
                return;
            }

            listaTickets = await _ticketServicio.ListarMisTickets(idUsuarioActual);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar mis tickets: {ex.Message}", Severity.Error);
            listaTickets = new List<Ticket>();
        }
    }

    private void VerDetalle(int idTicket)
    {
        _nav.NavigateTo($"/helpdesk/ticket/{idTicket}");
    }

    private Color ObtenerColorEstado(int idEstado)
    {
        return idEstado switch
        {
            1 => Color.Success,   // Abierto
            2 => Color.Warning,   // En Proceso
            3 => Color.Info,      // Por Proveedor
            4 => Color.Primary,   // Resuelto
            5 => Color.Dark,      // Cerrado
            _ => Color.Default
        };
    }
}
