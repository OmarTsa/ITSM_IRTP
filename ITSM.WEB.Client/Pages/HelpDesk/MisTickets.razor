@page "/helpdesk/mistickets"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@inject TicketServicio _ticketServicio
@inject NavigationManager _nav
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <MudText Typo="Typo.h5">Mis Tickets</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/helpdesk/nuevo">
            Nuevo Ticket
        </MudButton>
    </div>

    @if (listaTickets == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (listaTickets.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No tienes tickets registrados.</MudAlert>
    }
    else
    {
        <MudTable Items="@listaTickets" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="2">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>Fecha</MudTh>
                <MudTh>Título</MudTh>
                <MudTh>Categoría</MudTh>
                <MudTh>Estado</MudTh>
                <MudTh>Activo Afectado</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.IdTicket</MudTd>
                <MudTd DataLabel="Fecha">@context.FechaCreacion.ToShortDateString()</MudTd>
                <MudTd DataLabel="Título">@context.Titulo</MudTd>
                <MudTd DataLabel="Categoría">@context.Categoria?.Nombre</MudTd>
                <MudTd DataLabel="Estado">
                    <MudChip T="string" Color="@GetColorEstado(context.IdEstado)" Size="Size.Small">
                        @context.Estado?.Nombre
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Activo Afectado">
                    @(context.ActivoAfectado != null ? context.ActivoAfectado.CodigoPatrimonial : "-")
                </MudTd>
                <MudTd DataLabel="Acciones">
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Info" OnClick="@(() => VerDetalle(context.IdTicket))">
                        Ver
                    </MudButton>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

@code {
    private List<Ticket>? listaTickets;

    protected override async Task OnInitializedAsync()
    {
        // Asegúrate de que TicketServicio tenga el método ListarMisTickets
        listaTickets = await _ticketServicio.ListarMisTickets();
    }

    private void VerDetalle(int id)
    {
        _nav.NavigateTo($"/helpdesk/ticket/{id}");
    }

    private Color GetColorEstado(int idEstado)
    {
        return idEstado switch
        {
            1 => Color.Success, // Abierto
            2 => Color.Warning, // En Proceso
            3 => Color.Info,    // Por Proveedor
            4 => Color.Primary, // Resuelto
            5 => Color.Dark,    // Cerrado
            _ => Color.Default
        };
    }
}