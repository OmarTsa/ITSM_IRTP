@page "/helpdesk/mis-tickets"
@using ITSM.Entidades
@inject TicketServicio _ticketServicio
@inject NavigationManager Nav

@* CAMBIO CLAVE: Agregamos T="Ticket" para que 'context' sea reconocido *@
<MudTable T="Ticket" Items="@tickets" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Mis Tickets</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add" Href="/helpdesk/nuevo">
            Nuevo Ticket
        </MudButton>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Título</MudTh>
        <MudTh>Categoría</MudTh>
        <MudTh>Estado</MudTh>
        <MudTh>Fecha</MudTh>
        <MudTh>Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.IdTicket</MudTd>
        <MudTd DataLabel="Título">@context.Titulo</MudTd>
        <MudTd DataLabel="Categoría">@(context.Categoria?.Nombre ?? "-")</MudTd>
        <MudTd DataLabel="Estado">
            <MudChip T="string" Color="@GetColor(context.Estado?.Nombre)">@context.Estado?.Nombre</MudChip>
        </MudTd>
        <MudTd DataLabel="Fecha">@context.FechaCreacion.ToShortDateString()</MudTd>
        <MudTd DataLabel="Acciones">
            @* Ahora el compilador sabe que context es Ticket *@
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" OnClick="@(() => VerDetalle(context.IdTicket))" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<Ticket> tickets = new List<Ticket>();
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            tickets = await _ticketServicio.ObtenerMisTickets(1);
        }
        catch
        {
            tickets = new List<Ticket>();
        }
        loading = false;
    }

    private void VerDetalle(int id)
    {
        Nav.NavigateTo($"/helpdesk/detalle/{id}");
    }

    private Color GetColor(string? estado) => estado switch
    {
        "Abierto" => Color.Error,
        "En Proceso" => Color.Warning,
        "Resuelto" => Color.Success,
        _ => Color.Default
    };
}