@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using MudBlazor
@inject ITicketServicio _ticketServicio
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">
            Ticket: <b>@Ticket?.CodigoTicket</b>
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-4">
            @Ticket?.Titulo
        </MudText>

        <MudDivider Class="mb-4" />

        <MudSelect T="int?"
                   Label="Seleccionar Especialista"
                   @bind-Value="especialistaSeleccionado"
                   Variant="Variant.Outlined"
                   AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem T="int?" Value="null">-- Seleccione un especialista --</MudSelectItem>
            @if (Especialistas != null)
            {
                @foreach (var especialista in Especialistas)
                {
                    <MudSelectItem Value="@((int?)especialista.IdUsuario)">
                        @especialista.NombreCompleto - @especialista.Rol?.Nombre
                    </MudSelectItem>
                }
            }
        </MudSelect>

        @if (Ticket?.Especialista != null)
        {
            <MudAlert Severity="Severity.Info" Class="mt-3">
                Actualmente asignado a: <b>@Ticket.Especialista.NombreCompleto</b>
            </MudAlert>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancelar" Variant="Variant.Text">Cancelar</MudButton>
        <MudButton OnClick="Asignar" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary"
                   Disabled="@(especialistaSeleccionado == null || cargando)">
            @if (cargando)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <span class="ml-2">Asignando...</span>
            }
            else
            {
                <span>Asignar</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    dynamic? MudDialog { get; set; }

    [Parameter] 
    public Ticket? Ticket { get; set; }

    [Parameter] 
    public List<Usuario>? Especialistas { get; set; }

    private int? especialistaSeleccionado;
    private bool cargando;

    protected override void OnInitialized()
    {
        if (Ticket?.IdEspecialista != null)
        {
            especialistaSeleccionado = Ticket.IdEspecialista;
        }
    }

    private async Task Asignar()
    {
        if (especialistaSeleccionado == null || Ticket == null)
        {
            Snackbar.Add("Debe seleccionar un especialista", Severity.Warning);
            return;
        }

        cargando = true;
        try
        {
            await _ticketServicio.AsignarTicket(Ticket.IdTicket, especialistaSeleccionado.Value);
            Snackbar.Add($"Ticket {Ticket.CodigoTicket} asignado exitosamente", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al asignar ticket: {ex.Message}", Severity.Error);
        }
        finally
        {
            cargando = false;
        }
    }

    private void Cancelar()
    {
        MudDialog?.Cancel();
    }
}
