@page "/helpdesk/nuevo-ticket"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using ITSM.WEB.Client.Auth
@using System.Security.Claims
@using MudBlazor
@inject TicketServicio _ticketServicio
@inject InventarioServicio _inventarioServicio
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

@* Soporte para Blazor 8 Interactive *@
@rendermode InteractiveWebAssembly

<MudText Typo="Typo.h5" Class="mb-4"><b>Nueva Solicitud de Soporte</b></MudText>

<MudForm @bind-IsValid="@success">
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-6" Elevation="3">
                <MudTextField @bind-Value="ticket.Titulo" Label="Asunto" Variant="Variant.Outlined" Required="true" Class="mb-4" />
                <MudTextField @bind-Value="ticket.Descripcion" Label="Descripción" Variant="Variant.Outlined" Lines="5" Required="true" Class="mb-4" />

                <MudSelect T="int?" Label="Equipo Relacionado (Opcional)" @bind-Value="ticket.IdActivo" Variant="Variant.Outlined" Clearable="true">
                    @foreach (var act in activos)
                    {
                        <MudSelectItem T="int?" Value="@act.IdActivo">@act.CodInventario - @act.Nombre</MudSelectItem>
                    }
                </MudSelect>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Class="pa-6" Elevation="3">
                <MudSelect T="int" Label="Categoría" @bind-Value="ticket.IdCategoria" Variant="Variant.Outlined">
                    @foreach (var cat in categorias)
                    {
                        <MudSelectItem Value="@cat.IdCategoria">@cat.Nombre</MudSelectItem>
                    }
                </MudSelect>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-4" OnClick="Guardar" Disabled="@(!success)">Registrar Solicitud</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
    private Ticket ticket = new();
    private List<Activo> activos = new();
    private List<Categoria> categorias = new();
    private bool success;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        int idUsuario = 0;

        if (user.Identity?.IsAuthenticated == true)
        {
            var claim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (claim != null) idUsuario = int.Parse(claim.Value);
        }

        var t1 = _inventarioServicio.ListarActivos();
        var t2 = _ticketServicio.ObtenerCategorias();
        await Task.WhenAll(t1, t2);

        activos = t1.Result;
        categorias = t2.Result;
        ticket.IdSolicitante = idUsuario;
    }

    private async Task Guardar()
    {
        await _ticketServicio.GuardarTicket(ticket);
        Snackbar.Add("Solicitud creada exitosamente", Severity.Success);
        Navigation.NavigateTo("/helpdesk/mis-tickets");
    }
}