@page "/helpdesk/nuevo"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject TicketServicio TicketService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<PageTitle>Nuevo Ticket - ITSM</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8 mb-8">
    <MudPaper Elevation="3" Class="pa-6">

        <MudText Typo="Typo.h4" Color="Color.Primary" GutterBottom="true" Align="Align.Center">
            <b>Registrar Incidente / Requerimiento</b>
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-6" Align="Align.Center">
            Complete la información para clasificar correctamente su solicitud según ITIL v4.
        </MudText>

        <EditForm Model="@nuevoTicket" OnValidSubmit="Guardar">
            <DataAnnotationsValidator />

            <MudGrid>
                @* --- SECCIÓN 1: DETALLES BÁSICOS --- *@
                <MudItem xs="12">
                    <MudTextField Label="Título del Problema"
                                  @bind-Value="nuevoTicket.Titulo"
                                  For="@(() => nuevoTicket.Titulo)"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Title"
                                  Placeholder="Ej: El servidor de correos no responde..." />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" Label="Tipo de Ticket" @bind-Value="nuevoTicket.TipoTicket" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="@("Incidente")">Incidente (Algo se rompió)</MudSelectItem>
                        <MudSelectItem Value="@("Requerimiento")">Requerimiento (Necesito algo nuevo)</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="int" Label="Categoría" @bind-Value="nuevoTicket.IdCategoria" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        @foreach (var cat in listaCategorias)
                        {
                            <MudSelectItem Value="@cat.IdCategoria">@cat.Nombre</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* --- SECCIÓN 2: MATRIZ DE PRIORIZACIÓN ITIL --- *@
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Dense="true" Class="my-2">
                        <b>Matriz ITIL:</b> La Prioridad se calculará automáticamente basada en el Impacto y la Urgencia seleccionados.
                    </MudAlert>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="int" Label="Impacto (¿A quién afecta?)" @bind-Value="nuevoTicket.IdImpacto" Variant="Variant.Outlined" HelperText="Alcance del problema">
                        <MudSelectItem Value="1">Alto (Toda la empresa / Crítico)</MudSelectItem>
                        <MudSelectItem Value="2">Medio (Un departamento / Grupo)</MudSelectItem>
                        <MudSelectItem Value="3">Bajo (Solo a mí / Pocos usuarios)</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="int" Label="Urgencia (¿Cuándo se necesita?)" @bind-Value="nuevoTicket.IdUrgencia" Variant="Variant.Outlined" HelperText="Velocidad de respuesta requerida">
                        <MudSelectItem Value="1">Alta (El negocio está detenido)</MudSelectItem>
                        <MudSelectItem Value="2">Media (Afecta, pero hay alternativa)</MudSelectItem>
                        <MudSelectItem Value="3">Baja (Puede esperar / Programado)</MudSelectItem>
                    </MudSelect>
                </MudItem>

                @* --- SECCIÓN 3: CMDB --- *@
                <MudItem xs="12">
                    <MudTextField Label="Código Patrimonial (Opcional)"
                                  @bind-Value="nuevoTicket.CodigoPatrimonial"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.QrCode"
                                  HelperText="Escanee o ingrese el código de la etiqueta del activo afectado." />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField Label="Descripción Detallada"
                                  @bind-Value="nuevoTicket.Descripcion"
                                  For="@(() => nuevoTicket.Descripcion)"
                                  Variant="Variant.Outlined"
                                  Lines="5" />
                </MudItem>

                @* --- BOTONES --- *@
                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-4">
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="@(() => Navigation.NavigateTo("/dashboard"))">Cancelar</MudButton>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Disabled="@procesando">
                        @if (procesando)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Registrando...</MudText>
                        }
                        else
                        {
                            <MudText>Crear Ticket</MudText>
                        }
                    </MudButton>
                </MudItem>

            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private Ticket nuevoTicket = new Ticket();
    private List<Categoria> listaCategorias = new List<Categoria>();
    private bool procesando = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaCategorias = await TicketService.ObtenerCategorias();

            // Valores por defecto ITIL
            nuevoTicket.IdCategoria = listaCategorias.FirstOrDefault()?.IdCategoria ?? 0;
            nuevoTicket.IdImpacto = 3; // Bajo
            nuevoTicket.IdUrgencia = 3; // Bajo
            nuevoTicket.TipoTicket = "Incidente";
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error cargando categorías: " + ex.Message, Severity.Error);
        }
    }

    private async Task Guardar()
    {
        procesando = true;
        try
        {
            // 1. OBTENER USUARIO LOGUEADO REAL
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                // Buscamos el Claim "NameIdentifier" que guardamos en el Login (Controller)
                var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                {
                    nuevoTicket.IdSolicitante = userId;
                }
                else
                {
                    Snackbar.Add("Error: No se pudo identificar su usuario.", Severity.Error);
                    procesando = false;
                    return;
                }
            }
            else
            {
                Snackbar.Add("Su sesión ha expirado.", Severity.Warning);
                Navigation.NavigateTo("/login");
                return;
            }

            // 2. ENVIAR AL BACKEND
            await TicketService.GuardarTicket(nuevoTicket);

            Snackbar.Add("Ticket registrado exitosamente.", Severity.Success);
            Navigation.NavigateTo("/dashboard");
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al guardar: " + ex.Message, Severity.Error);
        }
        finally
        {
            procesando = false;
        }
    }
}