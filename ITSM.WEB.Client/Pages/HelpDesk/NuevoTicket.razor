@page "/helpdesk/nuevo-ticket"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@inject TicketServicio _ticketServicio
@inject InventarioServicio _inventarioServicio
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

@rendermode InteractiveWebAssembly

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h5" Class="mb-4">Nueva Solicitud de Soporte</MudText>
    <MudPaper Class="pa-6" Elevation="3">
        <MudForm @bind-IsValid="@success">
            <MudTextField @bind-Value="ticket.Titulo" Label="Asunto" Variant="Variant.Outlined" Required="true" />

            <MudGrid Class="mt-2">
                <MudItem xs="12" md="6">
                    <MudSelect T="int" Label="Categoría" Variant="Variant.Outlined" @bind-Value="ticket.IdCategoria" Required="true">
                        @foreach (var cat in categorias)
                        {
                            <MudSelectItem Value="@cat.IdCategoria">@cat.Nombre</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect T="int?" Label="Equipo Afectado" Variant="Variant.Outlined" @bind-Value="ticket.IdActivoAfectado">
                        <MudSelectItem Value="@((int?)null)">Ninguno</MudSelectItem>
                        @foreach (var activo in misActivos)
                        {
                            <MudSelectItem Value="@((int?)activo.IdActivo)">@($"{activo.CodigoPatrimonial} - {activo.Marca}")</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <MudTextField @bind-Value="ticket.Descripcion" Label="Descripción" Lines="5" Variant="Variant.Outlined" Class="mt-4" Required="true" />

            <div class="d-flex justify-end gap-2 mt-6">
                <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/helpdesk/mis-tickets"))">Cancelar</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="EnviarTicket" Disabled="@(!success)">Enviar</MudButton>
            </div>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private Ticket ticket = new() { IdEstado = 1, IdPrioridad = 3 };
    private List<Categoria> categorias = new();
    private List<Activo> misActivos = new();
    private bool success;

    protected override async Task OnInitializedAsync()
    {
        categorias = await _ticketServicio.ListarCategorias();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var idClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);

        if (idClaim != null && int.TryParse(idClaim.Value, out int idUsuario))
        {
            ticket.IdSolicitante = idUsuario;
            misActivos = await _inventarioServicio.ListarActivosPorUsuario(idUsuario);
        }
    }

    private async Task EnviarTicket()
    {
        try
        {
            await _ticketServicio.GuardarTicket(ticket);
            Snackbar.Add("Ticket creado", Severity.Success);
            Navigation.NavigateTo("/helpdesk/mis-tickets");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}