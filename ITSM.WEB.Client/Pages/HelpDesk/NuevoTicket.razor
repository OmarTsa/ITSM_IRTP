@page "/helpdesk/nuevo"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@inject TicketServicio _ticketServicio
@inject NavigationManager _nav
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Nuevo Ticket de Atención</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <EditForm Model="@nuevoTicket" OnValidSubmit="Guardar">
                <DataAnnotationsValidator />

                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="nuevoTicket.Titulo" Label="Título del Incidente/Requerimiento" Required="true" Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="string" Label="Tipo" @bind-Value="nuevoTicket.TipoTicket" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined">
                            <MudSelectItem Value="@("Incidente")">Incidente (Fallo)</MudSelectItem>
                            <MudSelectItem Value="@("Requerimiento")">Requerimiento (Solicitud)</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="int" Label="Categoría" @bind-Value="nuevoTicket.IdCategoria" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined">
                            <MudSelectItem Value="0">-- Seleccione --</MudSelectItem>
                            @foreach (var cat in listaCategorias)
                            {
                                <MudSelectItem Value="@cat.IdCategoria">@cat.Nombre</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="int" Label="Prioridad" @bind-Value="nuevoTicket.IdPrioridad" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined">
                            <MudSelectItem Value="3">Baja</MudSelectItem>
                            <MudSelectItem Value="2">Media</MudSelectItem>
                            <MudSelectItem Value="1">Alta</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="nuevoTicket.Descripcion" Label="Descripción Detallada" Lines="5" Required="true" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                <div class="d-flex justify-content-end mt-4">
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancelar" Class="me-2">Cancelar</MudButton>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Disabled="@cargando">
                        @if (cargando)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Procesando...</MudText>
                        }
                        else
                        {
                            <MudText>Registrar Ticket</MudText>
                        }
                    </MudButton>
                </div>
            </EditForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private Ticket nuevoTicket = new Ticket();
    private List<Categoria> listaCategorias = new();
    private bool cargando = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaCategorias = await _ticketServicio.ListarCategorias();

            // Valores por defecto
            nuevoTicket.FechaCreacion = DateTime.Now;
            nuevoTicket.IdEstado = 1; // Abierto
            nuevoTicket.IdPrioridad = 3; // Baja por defecto
            // El IdSolicitante se asigna en el Backend basado en el Token del usuario logueado
            // O podemos capturarlo aquí si tenemos el estado de autenticación
            nuevoTicket.IdSolicitante = 1; // Temporal, el backend debe sobrescribirlo con el usuario real
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al cargar datos iniciales", Severity.Warning);
        }
    }

    private async Task Guardar()
    {
        cargando = true;
        try
        {
            // CORRECCIÓN PRINCIPAL: Usamos el método que existe en el servicio 'RegistrarTicket'
            await _ticketServicio.RegistrarTicket(nuevoTicket);

            Snackbar.Add("Ticket registrado exitosamente", Severity.Success);
            _nav.NavigateTo("/helpdesk/mistickets");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            cargando = false;
        }
    }

    private void Cancelar()
    {
        _nav.NavigateTo("/helpdesk/mistickets");
    }
}