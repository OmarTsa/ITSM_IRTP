@page "/helpdesk/detalle/{Id:int}"
@using ITSM.Entidades
@using ITSM.Negocio
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject TicketNegocio TicketNegocio
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @if (ticket == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudPaper Elevation="3" Class="pa-6">
            <MudText Typo="Typo.h5" Class="mb-4">Gestión de Ticket: TKT-@ticket.IdTicket</MudText>
            <MudDivider Class="mb-4" />

            <MudGrid>
                <MudItem xs="12" sm="8">
                    <MudText Typo="Typo.h6">@ticket.Titulo</MudText>
                    <MudText Typo="Typo.body1" Class="mt-2">@ticket.Descripcion</MudText>
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                        Estado Actual: @ticket.Estado?.Nombre
                    </MudAlert>
                </MudItem>

                <MudItem xs="12" Class="d-flex gap-4 mt-6">
                    <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="@(() => ProcesarEstado(2))">En Proceso</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@(() => ProcesarEstado(4))">Resolver</MudButton>

                    <MudTooltip Text="Volver a la Bandeja">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" OnClick="@(() => Navigation.NavigateTo("/helpdesk/gestion"))" />
                    </MudTooltip>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }
    private Ticket? ticket;

    protected override async Task OnInitializedAsync()
    {
        ticket = await TicketNegocio.ObtenerTicketPorIdAsync(Id);
    }

    private async Task ProcesarEstado(int nuevoEstado)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var idClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (int.TryParse(idClaim, out int userIdOperador))
        {
            // Se envían los 4 argumentos: idTicket, nuevoEstado, idUsuarioOperador, notas
            await TicketNegocio.CambiarEstadoTicketAsync(Id, nuevoEstado, userIdOperador, "Actualización desde panel de gestión");

            Snackbar.Add("Estado actualizado correctamente", Severity.Success);
            ticket = await TicketNegocio.ObtenerTicketPorIdAsync(Id);
        }
        else
        {
            Snackbar.Add("No se pudo identificar al usuario operador", Severity.Error);
        }
    }
}