@page "/helpdesk/ticket/{IdTicket:int}"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using MudBlazor

@inject TicketServicio _ticketServicio
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/helpdesk/mis-tickets" Color="Color.Inherit" />
    <MudText Typo="Typo.h5">Gestión de Ticket #@IdTicket</MudText>
    <MudSpacer />
    @if (hayCambios)
    {
        <div class="animate__animated animate__pulse animate__infinite">
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Save" OnClick="GuardarCambiosTicket">
                Guardar Cambios
            </MudButton>
        </div>
    }
</MudStack>

@if (ticket == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
}
else
{
    <MudGrid>
        <MudItem xs="12" md="4">
            <MudPaper Elevation="3" Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3" Color="Color.Primary">Panel de Control</MudText>

                <MudStack Spacing="3">
                    <MudTextField Label="Asunto" Value="@ticket.Titulo" ReadOnly="true" Variant="Variant.Text" />

                    @if (ticket.Activo != null)
                    {
                        <MudField Label="Activo / Inventario" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.QrCode">
                            <b>@ticket.Activo.CodInventario</b> - @ticket.Activo.Nombre
                        </MudField>
                    }

                    <MudSelect T="int" Label="Estado Actual" @bind-Value="ticket.IdEstado" SelectedValuesChanged="DetectarCambio" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined">
                        @foreach (var estado in listaEstados)
                        {
                            <MudSelectItem Value="@estado.IdEstado">
                                <MudChip T="string" Color="@ObtenerColorEstado(estado.Nombre)" Size="Size.Small" Class="my-0">@estado.Nombre</MudChip>
                            </MudSelectItem>
                        }
                    </MudSelect>

                    <MudSelect T="int?" Label="Asignado a" @bind-Value="ticket.IdEspecialista" SelectedValuesChanged="DetectarCambio" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Clearable="true">
                        @foreach (var user in listaEspecialistas)
                        {
                            <MudSelectItem T="int?" Value="@user.IdUsuario">@user.NombreCompleto</MudSelectItem>
                        }
                    </MudSelect>

                    <MudField Label="Prioridad" Variant="Variant.Text">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Flag" Size="Size.Small" Color="@(ticket.Prioridad?.Nombre.Contains("Alta") == true ? Color.Error : Color.Success)" Class="mr-2" />
                            @ticket.Prioridad?.Nombre
                        </div>
                    </MudField>

                    <MudField Label="Solicitante" Variant="Variant.Text">@ticket.Solicitante?.NombreCompleto</MudField>
                </MudStack>
            </MudPaper>

            <MudPaper Elevation="3" Class="pa-4" Style="background-color:#FFF3E0;">
                <MudText Typo="Typo.subtitle2" Color="Color.Warning" Class="mb-1">Descripción Original:</MudText>
                <MudText Typo="Typo.body2" Style="font-style:italic;">"@ticket.Descripcion"</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="pa-4 d-flex flex-column" Style="height: 600px;">
                <MudText Typo="Typo.h6" Class="mb-3">Bitácora de Seguimiento</MudText>

                <div class="flex-grow-1 overflow-auto px-2 mb-4">
                    <MudTimeline TimelinePosition="TimelinePosition.Start">
                        <MudTimelineItem Color="Color.Info" Size="Size.Small">
                            <ItemOpposite>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@ticket.FechaCreacion.ToShortTimeString()</MudText>
                            </ItemOpposite>
                            <ItemContent>
                                <MudText Typo="Typo.body2"><b>Ticket Creado</b></MudText>
                            </ItemContent>
                        </MudTimelineItem>

                        @foreach (var detalle in detalles)
                        {
                            <MudTimelineItem Color="@(detalle.TipoAccion == 2 ? Color.Warning : (detalle.IdUsuario == ticket.IdSolicitante ? Color.Primary : Color.Success))" Size="Size.Small">
                                <ItemOpposite>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@detalle.FechaRegistro.ToShortDateString() @detalle.FechaRegistro.ToShortTimeString()</MudText>
                                </ItemOpposite>
                                <ItemContent>
                                    <MudPaper Elevation="1" Class="pa-3 mt-n2" Style="@(detalle.IdUsuario == ticket.IdSolicitante ? "background:#F5F5F5;" : "background:#E8F5E9;")">
                                        <MudText Typo="Typo.caption" Color="Color.Default"><b>@(detalle.Usuario?.NombreCompleto ?? "Usuario")</b> escribió:</MudText>
                                        <MudText Typo="Typo.body2" Class="mt-1">@detalle.Mensaje</MudText>
                                    </MudPaper>
                                </ItemContent>
                            </MudTimelineItem>
                        }
                    </MudTimeline>
                </div>

                <MudDivider Class="mb-3" />
                <MudStack Row="true">
                    <MudTextField @bind-Value="nuevoMensaje" Placeholder="Escribe una actualización..." Variant="Variant.Outlined" Margin="Margin.Dense" Lines="2" />
                    <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Primary" Variant="Variant.Filled" OnClick="EnviarComentario" Disabled="@string.IsNullOrWhiteSpace(nuevoMensaje)" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter] public int IdTicket { get; set; }
    private Ticket? ticket;
    private List<TicketDetalle> detalles = new();
    private List<Estado> listaEstados = new();
    private List<Usuario> listaEspecialistas = new();
    private string nuevoMensaje = "";
    private int idUsuarioActual = 1;
    private bool hayCambios = false;

    protected override async Task OnInitializedAsync()
    {
        var t1 = _ticketServicio.ObtenerEstados();
        var t2 = _ticketServicio.ObtenerEspecialistas();
        await Task.WhenAll(t1, t2);
        listaEstados = t1.Result;
        listaEspecialistas = t2.Result;
        await CargarDatosTicket();
    }

    private async Task CargarDatosTicket()
    {
        ticket = await _ticketServicio.ObtenerTicketPorId(IdTicket);
        if (ticket != null) detalles = await _ticketServicio.ObtenerDetalles(IdTicket);
        hayCambios = false;
    }

    private void DetectarCambio() => hayCambios = true;

    private async Task GuardarCambiosTicket()
    {
        if (ticket == null) return;
        try
        {
            await _ticketServicio.GuardarTicket(ticket);
            var nombreEstado = listaEstados.FirstOrDefault(e => e.IdEstado == ticket.IdEstado)?.Nombre;
            var nombreTecnico = listaEspecialistas.FirstOrDefault(u => u.IdUsuario == ticket.IdEspecialista)?.NombreCompleto ?? "Sin asignar";

            var autoLog = new TicketDetalle
            {
                IdTicket = ticket.IdTicket,
                IdUsuario = idUsuarioActual,
                Mensaje = $"SISTEMA: Estado actualizado a '{nombreEstado}'. Técnico: {nombreTecnico}.",
                TipoAccion = 2
            };
            await _ticketServicio.GuardarComentario(autoLog);
            Snackbar.Add("Guardado", Severity.Success);
            await CargarDatosTicket();
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
    }

    private async Task EnviarComentario()
    {
        if (string.IsNullOrWhiteSpace(nuevoMensaje)) return;
        try
        {
            var nuevo = new TicketDetalle { IdTicket = IdTicket, IdUsuario = idUsuarioActual, Mensaje = nuevoMensaje, FechaRegistro = DateTime.Now, TipoAccion = 1 };
            await _ticketServicio.GuardarComentario(nuevo);
            nuevoMensaje = "";
            await CargarDatosTicket();
        }
        catch { Snackbar.Add("Error al enviar", Severity.Error); }
    }

    private Color ObtenerColorEstado(string? estado)
    {
        return (estado?.ToUpper()) switch { "ABIERTO" => Color.Info, "EN PROCESO" => Color.Warning, "RESUELTO" => Color.Success, "CERRADO" => Color.Error, _ => Color.Default };
    }
}