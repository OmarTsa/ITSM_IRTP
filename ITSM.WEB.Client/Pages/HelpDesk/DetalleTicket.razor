@page "/helpdesk/ticket/{IdTicket:int}"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject TicketServicio TicketService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    @if (ticket == null)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudPaper Elevation="3" Class="pa-6">
            @* ENCABEZADO *@
            <div class="d-flex justify-space-between align-center mb-4">
                <div>
                    <MudText Typo="Typo.h5"><b>@ticket.Titulo</b></MudText>
                    <MudText Typo="Typo.caption">Ticket #@ticket.IdTicket | Creado: @ticket.FechaCreacion.ToString("g")</MudText>
                </div>
                <MudChip T="string" Color="@ObtenerColorEstado(ticket.IdEstado)" Variant="Variant.Filled">
                    @ticket.Estado?.Nombre
                </MudChip>
            </div>

            <MudDivider Class="my-4" />

            @* DETALLES *@
            <MudGrid>
                <MudItem xs="12" sm="8">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Descripción</MudText>
                    <MudPaper Class="pa-4 mt-2" Elevation="0" Outlined="true" Style="background-color: #f9f9f9;">
                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@ticket.Descripcion</MudText>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudStack>
                        <div>
                            <MudText Typo="Typo.subtitle2">Prioridad</MudText>
                            <MudText Typo="Typo.body2">@ticket.Prioridad?.Nombre</MudText>
                        </div>
                        <div>
                            <MudText Typo="Typo.subtitle2">Categoría</MudText>
                            <MudText Typo="Typo.body2">@ticket.Categoria?.Nombre</MudText>
                        </div>
                        <div>
                            <MudText Typo="Typo.subtitle2" Color="Color.Error">Vence (SLA)</MudText>
                            <MudText Typo="Typo.body2"><b>@ticket.FechaLimite?.ToString("g")</b></MudText>
                        </div>
                    </MudStack>
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-6" />

            @* ACCIONES *@
            <MudText Typo="Typo.h6" Class="mb-2">Acciones</MudText>
            <div class="d-flex gap-2">
                @if (ticket.IdEstado == 1) // Abierto -> En Proceso
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Warning" OnClick="@(() => ProcesarCambioEstado(2))">Tomar Caso</MudButton>
                }
                @if (ticket.IdEstado != 4) // Si no está cerrado -> Resolver
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@(() => ProcesarCambioEstado(4))">Resolver Ticket</MudButton>
                }
                <MudSpacer />
                <MudButton Variant="Variant.Text" OnClick="@(() => Navigation.NavigateTo("/helpdesk/mis-tickets"))">Volver</MudButton>
            </div>
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter] public int IdTicket { get; set; }
    private Ticket? ticket;

    protected override async Task OnInitializedAsync()
    {
        await CargarTicket();
    }

    private async Task CargarTicket()
    {
        try
        {
            ticket = await TicketService.ObtenerTicket(IdTicket);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al cargar: " + ex.Message, Severity.Error);
        }
    }

    private async Task ProcesarCambioEstado(int nuevoEstado)
    {
        try
        {
            // Obtener ID del usuario actual
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userIdStr = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (int.TryParse(userIdStr, out int userId))
            {
                await TicketService.CambiarEstado(IdTicket, nuevoEstado, userId, "Cambio de estado rápido");
                Snackbar.Add("Estado actualizado.", Severity.Success);
                await CargarTicket(); // Refrescar vista
            }
            else
            {
                Snackbar.Add("No se pudo identificar su usuario.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
    }

    private Color ObtenerColorEstado(int id) => id switch
    {
        1 => Color.Info,
        2 => Color.Warning,
        4 => Color.Success,
        _ => Color.Default
    };
}