@page "/admin/usuario/{Id:int?}"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@inject UsuarioServicio _usuarioServicio
@inject NavigationManager _nav
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">@(Id == null ? "Nuevo Usuario" : "Editar Usuario")</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <EditForm Model="@usuario" OnValidSubmit="Guardar">
                <DataAnnotationsValidator />
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Username" Label="Usuario (Login)" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Dni" Label="DNI" MaxLength="8" Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Nombres" Label="Nombres" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Apellidos" Label="Apellidos" Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Correo" Label="Correo Institucional" InputType="InputType.Email" Required="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Cargo" Label="Cargo" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="int" Label="Rol" @bind-Value="usuario.IdRol" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var rol in listaRoles)
                            {
                                <MudSelectItem Value="@rol.IdRol">@rol.Nombre</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="int" Label="Área" @bind-Value="usuario.IdArea" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var area in listaAreas)
                            {
                                <MudSelectItem Value="@area.IdArea">@area.Nombre</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="usuario.Password" Label="Contraseña" InputType="InputType.Password" HelperText="Dejar en blanco si no desea cambiarla (en edición)" />
                    </MudItem>

                    @if (Id != null)
                    {
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int" Label="Estado" @bind-Value="usuario.Estado">
                                <MudSelectItem Value="1">Activo</MudSelectItem>
                                <MudSelectItem Value="0">Inactivo</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    }

                </MudGrid>

                <div class="d-flex justify-content-end mt-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Class="me-2" OnClick="Cancelar">Cancelar</MudButton>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Guardar</MudButton>
                </div>
            </EditForm>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [Parameter] public int? Id { get; set; }

    private Usuario usuario = new Usuario();
    private List<Rol> listaRoles = new();
    private List<Area> listaAreas = new();

    protected override async Task OnInitializedAsync()
    {
        listaRoles = await _usuarioServicio.ListarRoles();
        listaAreas = await _usuarioServicio.ListarAreas();

        if (Id != null)
        {
            // CORREGIDO: El método en UsuarioServicio.cs se llama 'Obtener', no 'ObtenerPorId'
            var usuarioDb = await _usuarioServicio.Obtener(Id.Value);
            if (usuarioDb != null)
            {
                usuario = usuarioDb;
                usuario.PasswordHash = "";
            }
        }
        else
        {
            usuario.Estado = 1;
        }
    }

    private async Task Guardar()
    {
        try
        {
            // CORREGIDO: El método en UsuarioServicio.cs se llama 'Guardar', no 'GuardarUsuario'
            await _usuarioServicio.Guardar(usuario);
            Snackbar.Add("Usuario guardado correctamente", Severity.Success);
            _nav.NavigateTo("/admin/usuarios");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void Cancelar()
    {
        _nav.NavigateTo("/admin/usuarios");
    }
}