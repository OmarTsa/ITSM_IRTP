@page "/admin/usuarios"
@rendermode InteractiveWebAssembly
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@using ITSM.WEB.Client.Components.Dialogs
@inject IUsuarioServicio _usuarioServicio
@inject NavigationManager _nav
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "ADMINISTRADOR")]

<PageTitle>Gestión de Usuarios - ITSM</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary">
                <b>Gestión de Usuarios</b>
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Administración de usuarios del sistema
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.PersonAdd"
                   Href="/admin/usuario">
            Nuevo Usuario
        </MudButton>
    </div>

    @if (listaUsuarios == null)
    {
        <div class="d-flex justify-center align-center" style="min-height: 400px;">
            <div class="text-center">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                <MudText Typo="Typo.body1" Class="mt-4" Color="Color.Secondary">
                    Cargando usuarios del sistema...
                </MudText>
            </div>
        </div>
    }
    else if (listaUsuarios.Count == 0)
    {
        <MudPaper Elevation="2" Class="pa-8" Style="text-align: center;">
            <MudIcon Icon="@Icons.Material.Filled.PersonOff"
                     Size="Size.Large"
                     Color="Color.Secondary"
                     Style="font-size: 80px; opacity: 0.5;" />
            <MudText Typo="Typo.h6" Class="mt-4" Color="Color.Secondary">
                No hay usuarios registrados
            </MudText>
        </MudPaper>
    }
    else
    {
        <MudPaper Elevation="4" Style="border-radius: 12px; overflow: hidden;">
            <MudTable Items="@listaUsuarios"
                      Hover="true"
                      Striped="true"
                      Dense="false"
                      Filter="new Func<Usuario, bool>(FiltrarUsuarios)">

                <ToolBarContent>
                    <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                    <MudText Typo="Typo.h6">Usuarios Registrados</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="textoBusqueda"
                                  Placeholder="Buscar usuarios..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  IconSize="Size.Medium"
                                  Class="mt-0"
                                  Immediate="true"
                                  DebounceInterval="300">
                    </MudTextField>
                </ToolBarContent>

                <HeaderContent>
                    <MudTh Style="font-weight: bold;">Usuario</MudTh>
                    <MudTh Style="font-weight: bold;">Nombre Completo</MudTh>
                    <MudTh Style="font-weight: bold;">DNI</MudTh>
                    <MudTh Style="font-weight: bold;">Correo</MudTh>
                    <MudTh Style="font-weight: bold;">Rol</MudTh>
                    <MudTh Style="font-weight: bold;">Área</MudTh>
                    <MudTh Style="font-weight: bold;">Estado</MudTh>
                    <MudTh Style="font-weight: bold;">Acciones</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Usuario">
                        <div class="d-flex align-center">
                            <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-2">
                                @(context.Nombres?.Substring(0, 1) ?? "?")
                            </MudAvatar>
                            <span><b>@context.Username</b></span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Nombre">@context.NombreCompleto</MudTd>
                    <MudTd DataLabel="DNI">@context.Dni</MudTd>
                    <MudTd DataLabel="Correo">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-1" />
                            <span>@context.Correo</span>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Rol">
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Filled">
                            @context.Rol?.Nombre
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Área">@context.Area?.Nombre</MudTd>
                    <MudTd DataLabel="Estado">
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Color="@(context.Estado == 1 ? Color.Success : Color.Error)"
                                 Variant="Variant.Filled">
                            @(context.Estado == 1 ? "Activo" : "Inactivo")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Acciones">
                        <MudTooltip Text="Editar Usuario">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           Href="@($"/admin/usuario/{context.IdUsuario}")" />
                        </MudTooltip>

                        <MudTooltip Text="Cambiar Contraseña">
                            <MudIconButton Icon="@Icons.Material.Filled.Lock"
                                           Color="Color.Warning"
                                           Size="Size.Small"
                                           OnClick="@(() => AbrirDialogoCambiarPassword(context))" />
                        </MudTooltip>

                        @if (context.Estado == 1)
                        {
                            <MudTooltip Text="Desactivar Usuario">
                                <MudIconButton Icon="@Icons.Material.Filled.Block"
                                               Color="Color.Warning"
                                               Size="Size.Small"
                                               OnClick="@(() => CambiarEstado(context, 0))" />
                            </MudTooltip>
                        }
                        else
                        {
                            <MudTooltip Text="Activar Usuario">
                                <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                                               Color="Color.Success"
                                               Size="Size.Small"
                                               OnClick="@(() => CambiarEstado(context, 1))" />
                            </MudTooltip>
                        }
                        <MudTooltip Text="Eliminar Usuario">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => EliminarUsuario(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }"
                                   InfoFormat="{first_item}-{last_item} de {all_items}"
                                   RowsPerPageString="Filas por página:" />
                </PagerContent>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private List<Usuario>? listaUsuarios;
    private string textoBusqueda = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        try
        {
            listaUsuarios = await _usuarioServicio.Listar();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar usuarios: {ex.Message}", Severity.Error);
            listaUsuarios = new List<Usuario>();
        }
    }

    private bool FiltrarUsuarios(Usuario usuario)
    {
        if (string.IsNullOrWhiteSpace(textoBusqueda))
            return true;

        if (usuario.Username?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (usuario.NombreCompleto?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (usuario.Dni?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        if (usuario.Correo?.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        return false;
    }

    private async Task AbrirDialogoCambiarPassword(Usuario usuario)
    {
        var parametros = new DialogParameters
        {
            { "IdUsuario", usuario.IdUsuario },
            { "NombreUsuario", usuario.NombreCompleto }
        };

        var opciones = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseOnEscapeKey = false,
            BackdropClick = false
        };

        var dialogo = await DialogService.ShowAsync<CambiarPasswordDialog>("Cambiar Contraseña", parametros, opciones);
        var resultado = await dialogo.Result;

        if (!resultado.Canceled)
        {
            // La contraseña se cambió exitosamente
            // El Snackbar ya se muestra desde el diálogo
        }
    }

    private async Task CambiarEstado(Usuario usuario, int nuevoEstado)
    {
        var accion = nuevoEstado == 1 ? "activar" : "desactivar";
        var confirmar = await DialogService.ShowMessageBox(
            "Confirmar Acción",
            $"¿Está seguro de {accion} al usuario {usuario.NombreCompleto}?",
            yesText: "Sí", cancelText: "No");

        if (confirmar == true)
        {
            try
            {
                // ✅ LOG: Estado anterior
                var estadoAnterior = usuario.Estado;
                Console.WriteLine($"🔍 [FRONTEND] Usuario: {usuario.Username} | Estado Anterior: {estadoAnterior} | Nuevo Estado: {nuevoEstado}");

                // Cambiar estado
                usuario.Estado = nuevoEstado;
                
                // Actualizar FechaBaja según el estado
                if (nuevoEstado == 0)
                {
                    usuario.FechaBaja = DateTime.Now;
                    Console.WriteLine($"🔴 [FRONTEND] Usuario '{usuario.Username}' DESACTIVADO - FechaBaja: {usuario.FechaBaja}");
                }
                else
                {
                    usuario.FechaBaja = null;
                    Console.WriteLine($"🟢 [FRONTEND] Usuario '{usuario.Username}' REACTIVADO - FechaBaja: NULL");
                }

                // Enviar al backend
                await _usuarioServicio.Editar(usuario);
                
                Console.WriteLine($"✅ [FRONTEND] Cambio de estado guardado exitosamente en el backend");
                
                Snackbar.Add($"Usuario {(nuevoEstado == 1 ? "activado" : "desactivado")} correctamente", Severity.Success);
                await CargarUsuarios();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ [FRONTEND] Error al cambiar estado: {ex.Message}");
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            Console.WriteLine($"❌ [FRONTEND] Usuario canceló el cambio de estado para: {usuario.Username}");
        }
    }

    private async Task EliminarUsuario(Usuario usuario)
    {
        var confirmar = await DialogService.ShowMessageBox(
            "Confirmar Eliminación",
            $"¿Está seguro de eliminar al usuario {usuario.NombreCompleto}? Esta acción no se puede deshacer.",
            yesText: "Sí, Eliminar", cancelText: "Cancelar");

        if (confirmar == true)
        {
            try
            {
                await _usuarioServicio.Eliminar(usuario.IdUsuario);
                Snackbar.Add("Usuario eliminado correctamente", Severity.Success);
                await CargarUsuarios();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
            }
        }
    }
}





