@page "/login"
@layout LoginLayout
@using ITSM.Entidades
@using ITSM.WEB.Client.Auth
@using ITSM.WEB.Client.Servicios
@using MudBlazor
@inject UsuarioServicio _usuarioServicio
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

@rendermode InteractiveWebAssembly

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Class="pa-8" Elevation="4">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">ITSM - Ingreso</MudText>
        <MudForm @bind-IsValid="@success">
            <MudTextField @bind-Value="loginUser" Label="Usuario o Correo" Variant="Variant.Outlined"
                          Required="true" Class="mb-4" AdornmentIcon="@Icons.Material.Filled.Person" />

            <MudTextField @bind-Value="loginPassword" Label="Contraseña" Variant="Variant.Outlined"
                          InputType="InputType.Password" Required="true" Class="mb-6" />

            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large"
                       OnClick="EjecutarLogin" Disabled="@(cargando || !success)">
                @if (cargando)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Iniciando sesión...</MudText>
                }
                else
                {
                    <MudText>Entrar al Sistema</MudText>
                }
            </MudButton>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private string loginUser = "";
    private string loginPassword = "";
    private bool success;
    private bool cargando;

    private async Task EjecutarLogin()
    {
        cargando = true;
        try
        {
            var usuario = await _usuarioServicio.Login(loginUser, loginPassword);

            if (usuario != null)
            {
                var authProvider = (ProveedorAutenticacion)AuthStateProvider;
                await authProvider.IniciarSesion(usuario);

                // Redirección forzada para limpiar estados previos y cargar permisos
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Snackbar.Add("Acceso denegado: Credenciales inválidas", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error de comunicación: {ex.Message}", Severity.Error);
        }
        finally
        {
            cargando = false;
        }
    }
}