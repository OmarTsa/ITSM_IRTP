@page "/login"
@layout LoginLayout
@using ITSM.WEB.Client.Servicios
@using ITSM.Entidades
@inject ServicioSesion _servicioSesion
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudPaper Class="pa-8 d-flex flex-column align-center" Elevation="3" Style="width: 400px; border-radius: 12px;">

    <div class="d-flex flex-column align-center mb-6">
        <MudIcon Icon="@Icons.Material.Filled.SupportAgent" Color="Color.Primary" Style="width: 64px; height: 64px;" />
        <MudText Typo="Typo.h5" Color="Color.Primary" Style="font-weight: 700;">ITSM | Acceso</MudText>
    </div>

    <MudForm @bind-IsValid="@success" Style="width: 100%;">

        <MudTextField @bind-Value="email" Label="Correo / Usuario" Variant="Variant.Outlined"
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person"
                      Class="mb-4" Required="true" />

        <MudTextField @bind-Value="password" Label="Contraseña" Variant="Variant.Outlined"
                      InputType="InputType.Password" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Lock"
                      Class="mb-6" Required="true" />

        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true"
                   OnClick="IniciarSesion" Disabled="@procesando">
            @if (procesando)
            {
                <MudText>Cargando...</MudText>
            }
            else
            {

                <MudText>INGRESAR</MudText>
            }
        </MudButton>

    </MudForm>
</MudPaper>

@code {
    bool success;
    bool procesando = false;
    string email = "";
    string password = "";

    private async Task IniciarSesion()
    {
        procesando = true;
        try
        {
            // El servicio se encarga de todo. Solo esperamos true o false.
            var resultado = await _servicioSesion.IniciarSesion(email, password);

            if (resultado)
            {
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                Snackbar.Add("Credenciales inválidas", Severity.Error);
                procesando = false;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            procesando = false;
        }
    }
}