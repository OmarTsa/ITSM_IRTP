@page "/inventario/nuevo"
@page "/inventario/editar/{IdActivo:int}"
@using ITSM.Entidades
@using ITSM.WEB.Client.Servicios
@inject IInventarioServicio _inventarioServicio
@inject IUsuarioServicio _usuarioServicio
@inject NavigationManager _nav
@inject ISnackbar Snackbar
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>@(IdActivo == null ? "Nuevo Activo" : "Editar Activo") - ITSM</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudCard Elevation="4" Style="border-radius: 12px;">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">
                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2" />
                    @(IdActivo == null ? "Registrar Nuevo Activo" : "Editar Activo")
                </MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent>
            <EditForm Model="@activo" OnValidSubmit="Guardar">
                <DataAnnotationsValidator />

                <MudGrid>
                    <!-- Información Básica -->
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                            Información Básica
                        </MudText>
                        <MudDivider />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.Nombre"
                                      Label="Nombre del Activo"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="El nombre es requerido" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.CodigoPatrimonial"
                                      Label="Código Patrimonial"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="int?"
                                   Label="Tipo de Activo"
                                   @bind-Value="activo.IdTipo"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   Clearable="true">
                            @foreach (var tipo in listaTipos)
                            {
                                <MudSelectItem T="int?" Value="@((int?)tipo.IdTipo)">@tipo.Nombre</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="int?"
                                   Label="Estado"
                                   @bind-Value="activo.IdEstado"
                                   Variant="Variant.Outlined"
                                   Required="true">
                            @foreach (var estado in listaEstados)
                            {
                                <MudSelectItem T="int?" Value="@((int?)estado.IdEstado)">
                                    <MudChip T="string" Size="Size.Small" Color="@ObtenerColorEstado(estado.Color)">
                                        @estado.Nombre
                                    </MudChip>
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- Detalles del Equipo -->
                    <MudItem xs="12" Class="mt-4">
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                            Detalles del Equipo
                        </MudText>
                        <MudDivider />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="activo.Descripcion"
                                      Label="Descripción"
                                      Variant="Variant.Outlined"
                                      Lines="2" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.Marca"
                                      Label="Marca"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.Modelo"
                                      Label="Modelo"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.NumeroSerie"
                                      Label="Número de Serie"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.UbicacionFisica"
                                      Label="Ubicación Física"
                                      Variant="Variant.Outlined"
                                      Placeholder="Ej: Piso 2, Oficina 201" />
                    </MudItem>

                    <!-- Especificaciones Técnicas -->
                    <MudItem xs="12" Class="mt-4">
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                            Especificaciones Técnicas (Opcional)
                        </MudText>
                        <MudDivider />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.Procesador"
                                      Label="Procesador"
                                      Variant="Variant.Outlined"
                                      Placeholder="Ej: Intel Core i5-12400" />
                    </MudItem>

                    <MudItem xs="12" sm="3">
                        <MudNumericField @bind-Value="activo.RamGb"
                                         Label="RAM (GB)"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Max="1024" />
                    </MudItem>

                    <MudItem xs="12" sm="3">
                        <MudNumericField @bind-Value="activo.DiscoGb"
                                         Label="Disco (GB)"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Max="10000" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect T="string"
                                   Label="Tipo de Disco"
                                   @bind-Value="activo.TipoDisco"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            <MudSelectItem Value="@("SSD")">SSD</MudSelectItem>
                            <MudSelectItem Value="@("HDD")">HDD</MudSelectItem>
                            <MudSelectItem Value="@("NVME")">NVMe</MudSelectItem>
                            <MudSelectItem Value="@("HIBRIDO")">Híbrido</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="activo.SistemaOperativo"
                                      Label="Sistema Operativo"
                                      Variant="Variant.Outlined"
                                      Placeholder="Ej: Windows 11 Pro" />
                    </MudItem>

                    <!-- Configuración de Red -->
                    <MudItem xs="12" Class="mt-4">
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                            Configuración de Red
                        </MudText>
                        <MudDivider />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="activo.Hostname"
                                      Label="Hostname"
                                      Variant="Variant.Outlined"
                                      Placeholder="Ej: PC-ADMIN-01" />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="activo.IpAsignada"
                                      Label="IP Asignada"
                                      Variant="Variant.Outlined"
                                      Placeholder="Ej: 192.168.1.100" />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="activo.MacAddress"
                                      Label="MAC Address"
                                      Variant="Variant.Outlined"
                                      Placeholder="Ej: 00:1A:2B:3C:4D:5E" />
                    </MudItem>

                    <!-- Asignación -->
                    <MudItem xs="12" Class="mt-4">
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                            Asignación de Usuario
                        </MudText>
                        <MudDivider />
                    </MudItem>

                    <MudItem xs="12">
                        <MudSelect T="int?"
                                   Label="Usuario Asignado"
                                   @bind-Value="activo.IdUsuarioAsignado"
                                   Variant="Variant.Outlined"
                                   Clearable="true">
                            @foreach (var usuario in listaUsuarios)
                            {
                                <MudSelectItem T="int?" Value="@((int?)usuario.IdUsuario)">
                                    @usuario.NombreCompleto - @usuario.Area?.Nombre
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- Información Financiera -->
                    <MudItem xs="12" Class="mt-4">
                        <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">
                            Información Financiera
                        </MudText>
                        <MudDivider />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudDatePicker @bind-Date="activo.FechaAdquisicion"
                                       Label="Fecha de Adquisición"
                                       Variant="Variant.Outlined"
                                       Editable="true" />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="activo.PrecioAdquisicion"
                                         Label="Precio de Adquisición"
                                         Variant="Variant.Outlined"
                                         Format="N2"
                                         AdornmentText="S/."
                                         Adornment="Adornment.Start" />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="activo.Proveedor"
                                      Label="Proveedor"
                                      Variant="Variant.Outlined" />
                    </MudItem>

                    <!-- Observaciones -->
                    <MudItem xs="12" Class="mt-4">
                        <MudTextField @bind-Value="activo.Observaciones"
                                      Label="Observaciones"
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      Placeholder="Información adicional relevante..." />
                    </MudItem>
                </MudGrid>

            </EditForm>
        </MudCardContent>

        <MudCardActions Class="pa-4">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="Cancelar"
                       StartIcon="@Icons.Material.Filled.Cancel">
                Cancelar
            </MudButton>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="Guardar"
                       Disabled="@guardando"
                       StartIcon="@Icons.Material.Filled.Save">
                @if (guardando)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Guardando...</span>
                }
                else
                {
                    <span>Guardar Activo</span>
                }
            </MudButton>
        </MudCardActions>
    </MudCard>
</MudContainer>

@code {
    [Parameter] public int? IdActivo { get; set; }

    private Activo activo = new();
    private List<TipoActivo> listaTipos = new();
    private List<EstadoActivo> listaEstados = new();
    private List<Usuario> listaUsuarios = new();
    private bool guardando = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();

        if (IdActivo != null)
        {
            var activoDb = await _inventarioServicio.ObtenerPorId(IdActivo.Value);
            if (activoDb != null)
            {
                activo = activoDb;
            }
        }
        else
        {
            // Valores por defecto para nuevo activo
            activo.Nombre = string.Empty;
            activo.FechaRegistro = DateTime.Now;
            activo.Eliminado = 0;
            activo.VidaUtilAnios = 6;
        }
    }

    private async Task CargarDatos()
    {
        try
        {
            listaTipos = await _inventarioServicio.ListarTipos();
            listaEstados = await _inventarioServicio.ListarEstados();
            listaUsuarios = await _usuarioServicio.Listar();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Warning);
        }
    }

    private async Task Guardar()
    {
        guardando = true;
        try
        {
            await _inventarioServicio.GuardarActivo(activo);
            Snackbar.Add("Activo guardado exitosamente", Severity.Success);
            _nav.NavigateTo("/inventario");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
        finally
        {
            guardando = false;
        }
    }

    private void Cancelar()
    {
        _nav.NavigateTo("/inventario");
    }

    private Color ObtenerColorEstado(string colorHex)
    {
        return colorHex switch
        {
            "#28a745" => Color.Success,
            "#007bff" => Color.Info,
            "#ffc107" => Color.Warning,
            "#dc3545" => Color.Error,
            "#6c757d" => Color.Default,
            _ => Color.Primary
        };
    }
}
