@page "/dashboard"
@using ITSM.Entidades.DTOs
@using ITSM.WEB.Client.Servicios
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDashboardServicio _dashboardServicio
@inject NavigationManager Navigation

<PageTitle>Dashboard - ITSM</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">

    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary">
                <b>Dashboard de Gestión</b>
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Panel de control y métricas del sistema
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="CargarDatos">
            Actualizar
        </MudButton>
    </div>

    @if (cargando)
    {
        <div class="d-flex justify-center align-center" style="min-height: 300px;">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        </div>
    }
    else if (kpis == null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">
            <MudText>No se pudieron cargar los datos del dashboard. Intente nuevamente.</MudText>
        </MudAlert>
    }
    else
    {
        <!-- KPIs Principales -->
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6" Style="border-left: 5px solid #594AE2; border-radius: 12px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Tickets</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Primary">
                                <b>@kpis.TotalTickets</b>
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.ConfirmationNumber"
                                 Size="Size.Large"
                                 Color="Color.Primary"
                                 Style="font-size: 48px; opacity: 0.3;" />
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6" Style="border-left: 5px solid #FF6B35; border-radius: 12px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Abiertos</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Warning">
                                <b>@kpis.Abiertos</b>
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline"
                                 Size="Size.Large"
                                 Color="Color.Warning"
                                 Style="font-size: 48px; opacity: 0.3;" />
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6" Style="border-left: 5px solid #4ECDC4; border-radius: 12px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">En Proceso</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Info">
                                <b>@kpis.EnProceso</b>
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Autorenew"
                                 Size="Size.Large"
                                 Color="Color.Info"
                                 Style="font-size: 48px; opacity: 0.3;" />
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="4" Class="pa-6" Style="border-left: 5px solid #5CB85C; border-radius: 12px;">
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Resueltos</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Success">
                                <b>@kpis.Resueltos</b>
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                                 Size="Size.Large"
                                 Color="Color.Success"
                                 Style="font-size: 48px; opacity: 0.3;" />
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Accesos Rápidos -->
        <MudPaper Elevation="4" Class="pa-6 mt-6" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" Class="mb-4">
                <b>Accesos Rápidos</b>
            </MudText>
            <MudGrid>
                <MudItem xs="12" sm="6" md="4">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.AddCircleOutline"
                               Href="/helpdesk/nuevo"
                               Style="height: 60px; border-radius: 10px;">
                        Nuevo Ticket
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.ViewList"
                               Href="/helpdesk/mistickets"
                               Style="height: 60px; border-radius: 10px;">
                        Mis Tickets
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Tertiary"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Assignment"
                               Href="/helpdesk/gestion"
                               Style="height: 60px; border-radius: 10px;">
                        Gestión Tickets
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

</MudContainer>

@code {
    private DashboardKpi? kpis;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        try
        {
            kpis = await _dashboardServicio.ObtenerKpi();

            if (kpis == null)
            {
                // Datos de ejemplo si no hay conexión
                kpis = new DashboardKpi
                {
                    TotalTickets = 0,
                    Abiertos = 0,
                    EnProceso = 0,
                    Resueltos = 0
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar KPIs: {ex.Message}");
            kpis = null;
        }
        finally
        {
            cargando = false;
        }
    }
}
