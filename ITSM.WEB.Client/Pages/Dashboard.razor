@page "/dashboard"
@using ITSM.Negocio
@using ITSM.Entidades
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject TicketNegocio TicketNegocio

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-6"><b>Dashboard de Gestión TI - IRTP</b></MudText>

    <MudGrid>
        @* Resumen en Tarjetas *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="4" Style="border-left: 8px solid var(--mud-palette-primary);">
                <MudText Typo="Typo.h6">Total Tickets</MudText>
                <MudText Typo="Typo.h3">@totalTickets</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="4" Style="border-left: 8px solid var(--mud-palette-error);">
                <MudText Typo="Typo.h6">Críticos (SLA 4h)</MudText>
                <MudText Typo="Typo.h3">@ticketsCriticos</MudText>
            </MudPaper>
        </MudItem>

        @* Gráfico de Torta - Estados *@
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="4">
                <MudText Typo="Typo.h6" Align="Align.Center">Tickets por Estado</MudText>
                <MudChart ChartType="ChartType.Pie" InputData="@dataEstados" InputLabels="@labelsEstados" Width="300px" Height="300px" />
            </MudPaper>
        </MudItem>

        @* Gráfico de Barras - Prioridades *@
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="4">
                <MudText Typo="Typo.h6" Align="Align.Center">Distribución de Prioridades</MudText>
                <MudChart ChartType="ChartType.Donut" InputData="@dataPrioridades" InputLabels="@labelsPrioridades" Width="300px" Height="300px" />
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int totalTickets = 0;
    private int ticketsCriticos = 0;

    private double[] dataEstados = { };
    private string[] labelsEstados = { };

    private double[] dataPrioridades = { };
    private string[] labelsPrioridades = { };

    protected override async Task OnInitializedAsync()
    {
        var todos = await TicketNegocio.ListarTodosLosTicketsAsync();
        totalTickets = todos.Count;
        ticketsCriticos = todos.Count(t => t.IdPrioridad == 1);

        // Datos para gráfico de Estados
        var estadosDict = await TicketNegocio.ObtenerTicketsPorEstadoAsync();
        dataEstados = estadosDict.Values.Select(v => (double)v).ToArray();
        labelsEstados = estadosDict.Keys.ToArray();

        // Datos para gráfico de Prioridades
        var prioridadesDict = await TicketNegocio.ObtenerTicketsPorPrioridadAsync();
        dataPrioridades = prioridadesDict.Values.Select(v => (double)v).ToArray();
        labelsPrioridades = prioridadesDict.Keys.ToArray();
    }
}