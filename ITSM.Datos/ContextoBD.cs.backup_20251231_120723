using Microsoft.EntityFrameworkCore;
using ITSM.Entidades;

namespace ITSM.Datos
{
    public class ContextoBD : DbContext
    {
        public ContextoBD(DbContextOptions<ContextoBD> options) : base(options) { }

        // --- SEGURIDAD ---
        public DbSet<Usuario> Usuarios { get; set; }
        public DbSet<Rol> Roles { get; set; }
        public DbSet<Area> Areas { get; set; }

        // --- HELPDESK ---
        public DbSet<Ticket> Tickets { get; set; }
        public DbSet<TicketDetalle> TicketDetalles { get; set; }
        public DbSet<EstadoTicket> Estados { get; set; }
        public DbSet<Categoria> Categorias { get; set; }
        public DbSet<Prioridad> Prioridades { get; set; }

        // --- INVENTARIO ---
        public DbSet<Activo> Activos { get; set; }
        public DbSet<TipoActivo> TiposActivo { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // ===================================================================
            // CONFIGURACIÓN DE LLAVES PRIMARIAS (verificadas con entidades)
            // ===================================================================
            
            modelBuilder.Entity<Usuario>().HasKey(u => u.IdUsuario);
            modelBuilder.Entity<Rol>().HasKey(r => r.IdRol);
            modelBuilder.Entity<Area>().HasKey(a => a.IdArea);
            modelBuilder.Entity<Ticket>().HasKey(t => t.IdTicket);
            modelBuilder.Entity<TicketDetalle>().HasKey(td => td.IdDetalle); // ✓ CORREGIDO
            modelBuilder.Entity<EstadoTicket>().HasKey(e => e.IdEstado);
            modelBuilder.Entity<Categoria>().HasKey(c => c.IdCategoria);
            modelBuilder.Entity<Prioridad>().HasKey(p => p.IdPrioridad);
            modelBuilder.Entity<Activo>().HasKey(a => a.IdActivo);
            modelBuilder.Entity<TipoActivo>().HasKey(t => t.IdTipo);

            // ===================================================================
            // CONFIGURACIÓN DE RELACIONES (FOREIGN KEYS)
            // ===================================================================
            
            // Usuario -> Rol
            modelBuilder.Entity<Usuario>()
                .HasOne(u => u.Rol)
                .WithMany()
                .HasForeignKey(u => u.IdRol)
                .OnDelete(DeleteBehavior.Restrict);

            // Usuario -> Area
            modelBuilder.Entity<Usuario>()
                .HasOne(u => u.Area)
                .WithMany()
                .HasForeignKey(u => u.IdArea)
                .OnDelete(DeleteBehavior.SetNull);

            // Ticket -> EstadoTicket
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.Estado)
                .WithMany()
                .HasForeignKey(t => t.IdEstado)
                .OnDelete(DeleteBehavior.Restrict);

            // Ticket -> Categoria
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.Categoria)
                .WithMany()
                .HasForeignKey(t => t.IdCategoria)
                .OnDelete(DeleteBehavior.Restrict);

            // Ticket -> Prioridad
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.Prioridad)
                .WithMany()
                .HasForeignKey(t => t.IdPrioridad)
                .OnDelete(DeleteBehavior.Restrict);

            // Ticket -> Usuario (Solicitante)
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.Solicitante)
                .WithMany()
                .HasForeignKey(t => t.IdSolicitante)
                .OnDelete(DeleteBehavior.Restrict);

            // Ticket -> Usuario (Especialista)
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.Especialista)
                .WithMany()
                .HasForeignKey(t => t.IdEspecialista)
                .OnDelete(DeleteBehavior.SetNull);

            // Ticket -> Area (AreaSolicitante)
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.AreaSolicitante)
                .WithMany()
                .HasForeignKey(t => t.IdAreaSolicitante)
                .OnDelete(DeleteBehavior.SetNull);

            // Ticket -> Activo (ActivoAfectado)
            modelBuilder.Entity<Ticket>()
                .HasOne(t => t.ActivoAfectado)
                .WithMany()
                .HasForeignKey(t => t.IdActivoAfectado)
                .OnDelete(DeleteBehavior.SetNull);

            // Activo -> TipoActivo (usando IdTipoActivo)
            modelBuilder.Entity<Activo>()
                .HasOne(a => a.TipoActivo)
                .WithMany()
                .HasForeignKey(a => a.IdTipoActivo)
                .OnDelete(DeleteBehavior.Restrict);

            // Activo -> Usuario (UsuarioAsignado)
            modelBuilder.Entity<Activo>()
                .HasOne(a => a.UsuarioAsignado)
                .WithMany()
                .HasForeignKey(a => a.IdUsuarioAsignado)
                .OnDelete(DeleteBehavior.SetNull);

            // Activo -> EstadoTicket (Estado)
            modelBuilder.Entity<Activo>()
                .HasOne(a => a.Estado)
                .WithMany()
                .HasForeignKey(a => a.IdEstado)
                .OnDelete(DeleteBehavior.Restrict);

            // TicketDetalle -> Usuario
            modelBuilder.Entity<TicketDetalle>()
                .HasOne(td => td.Usuario)
                .WithMany()
                .HasForeignKey(td => td.IdUsuario)
                .OnDelete(DeleteBehavior.Restrict);

            // ===================================================================
            // CONFIGURACIÓN DE ÍNDICES ÚNICOS
            // ===================================================================
            
            modelBuilder.Entity<Usuario>()
                .HasIndex(u => u.Username)
                .IsUnique();

            modelBuilder.Entity<Usuario>()
                .HasIndex(u => u.Correo)
                .IsUnique();

            modelBuilder.Entity<Usuario>()
                .HasIndex(u => u.Dni)
                .IsUnique();

            modelBuilder.Entity<Ticket>()
                .HasIndex(t => t.CodigoTicket)
                .IsUnique();

            // ===================================================================
            // VALORES POR DEFECTO (respetando lo que ya está en las entidades)
            // ===================================================================
            
            modelBuilder.Entity<Usuario>()
                .Property(u => u.FechaCreacion)
                .HasDefaultValueSql("CURRENT_TIMESTAMP");

            modelBuilder.Entity<Ticket>()
                .Property(t => t.FechaCreacion)
                .HasDefaultValueSql("SYSDATE");

            modelBuilder.Entity<Activo>()
                .Property(a => a.FechaRegistro)
                .HasDefaultValueSql("SYSDATE");
        }
    }
}
